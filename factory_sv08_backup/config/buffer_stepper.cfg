[mcu buffer_mcu]
canbus_uuid: 704fe1305bd6

[buffer_stepper filament_buffer]
step_pin: buffer_mcu: PA8           
dir_pin: buffer_mcu: PA9           
enable_pin: !buffer_mcu: PA11       
microsteps: 16                      
rotation_distance: 9.75               
velocity: 150                        
accel: 5000                         
push_length: 25                  
full_steps_per_rotation: 200   
push_pin: ^buffer_mcu: PB11

[tmc2209 buffer_stepper filament_buffer]
uart_pin: buffer_mcu: PA12
interpolate: True
run_current: 0.9
hold_current: 0.4
sense_resistor: 0.150          
uart_address: 3

[filament_switch_sensor filament_sensor]
pause_on_runout: False
switch_pin: ^buffer_mcu: PA10
event_delay: 0.1
insert_gcode:
    SET_PIN PIN=green_led VALUE=1.00
    SET_GCODE_VARIABLE MACRO=variables VARIABLE=is_manual_feeding VALUE=False
runout_gcode:
    CONTINUE_PRINT_D D={1100}
    {action_respond_info("filament exhausted!")}
    
[output_pin red_led]
pin: !buffer_mcu: PC14
value: 0

[output_pin blue_led]
pin: !buffer_mcu: PC15
value: 0

[output_pin green_led]
pin: !buffer_mcu:PB1  
value: 0    

[gcode_button manual_push] 
pin: buffer_mcu: PA1
press_gcode:
release_gcode:
    {% if printer["filament_switch_sensor filament_sensor"].filament_detected and printer["print_stats"].state != "printing" and printer["gcode_button stall_push_stop"].state != "PRESSED" %}
        {% if printer["gcode_macro variables"].is_manual_feeding %}
            SET_GCODE_VARIABLE MACRO=variables VARIABLE=stop_feeding VALUE=True
            SET_GCODE_VARIABLE MACRO=variables VARIABLE=is_manual_feeding VALUE=False
            BUFFER_STEPPER STEPPER=filament_buffer ENABLE=0
            UPDATE_DELAYED_GCODE ID=feed_loop DURATION=0
        {% else %}
            SET_GCODE_VARIABLE MACRO=variables VARIABLE=stop_feeding VALUE=False
            SET_GCODE_VARIABLE MACRO=variables VARIABLE=is_manual_feeding VALUE=True
            BUFFER_STEPPER STEPPER=filament_buffer ENABLE=1
            FEED_LOOP
        {% endif %}
    {% endif %}

[gcode_button stall_push_stop] 
pin: ^buffer_mcu: PB10
press_gcode:
    SET_GCODE_VARIABLE MACRO=variables VARIABLE=stop_feeding VALUE=True
    SET_GCODE_VARIABLE MACRO=variables VARIABLE=is_manual_feeding VALUE=False
release_gcode:

[gcode_macro variables]
variable_stop_feeding: False
variable_is_manual_feeding: False
variable_plug_status: False
variable_winding_status: False
variable_clog_retry: False
gcode:

[gcode_macro FEED_LOOP] 
gcode:
  {% if printer["gcode_macro variables"].stop_feeding|default(False) %}
    { action_respond_info("stop push filament") }
    SET_GCODE_VARIABLE MACRO=variables VARIABLE=stop_feeding VALUE=False
  {% else %}
    BUFFER_STEPPER STEPPER=filament_buffer MOVE=2 SPEED=50
    UPDATE_DELAYED_GCODE ID=feed_loop DURATION=0.06
  {% endif %}

[delayed_gcode feed_loop]
gcode:
  FEED_LOOP

[gcode_macro NOZZLE_CLOG_CHECK]
variable_extrusion_start: 0
variable_time_start: 0
gcode:
    {% set extrusion_start = printer.print_stats.filament_used|int %}
    {% set time_start = printer.print_stats.print_duration|int %}
    SET_GCODE_VARIABLE MACRO=NOZZLE_CLOG_CHECK VARIABLE=extrusion_start VALUE={extrusion_start}
    SET_GCODE_VARIABLE MACRO=NOZZLE_CLOG_CHECK VARIABLE=time_start VALUE={time_start}
    {% if time_start > 0 %}
        UPDATE_DELAYED_GCODE ID=CHECK_NOZZLE_CLOG DURATION=1
    {% endif %}
    
[delayed_gcode CHECK_NOZZLE_CLOG]
gcode:
    {% set current_extrusion = printer.print_stats.filament_used|int %}
    {% set extrusion_start = printer["gcode_macro NOZZLE_CLOG_CHECK"].extrusion_start|int %}
    {% set delta_extrusion = current_extrusion - extrusion_start %}
    {% if delta_extrusion > 50 and not printer["gcode_macro variables"].clog_retry %}
        {% if printer["print_stats"].state == "printing" and printer["filament_switch_sensor filament_sensor"].filament_detected and printer["gcode_macro variables"].is_manual_feeding != True %}
            SET_GCODE_VARIABLE MACRO=variables VARIABLE=clog_retry VALUE=True
            UPDATE_DELAYED_GCODE ID=CHECK_NOZZLE_CLOG DURATION=5
        {% else %}
            UPDATE_DELAYED_GCODE ID=CHECK_NOZZLE_CLOG DURATION=0
        {% endif %}
    {% elif delta_extrusion > 50 and printer["gcode_macro variables"].clog_retry%}
        SET_PIN PIN=green_led VALUE=0  
        SET_PIN PIN=red_led VALUE=1   
        PAUSE
        { action_respond_info("Nozzle clog detected! Extruded only: " ~ delta_extrusion) }
        SET_GCODE_VARIABLE MACRO=variables VARIABLE=plug_status VALUE=True
        SET_GCODE_VARIABLE MACRO=variables VARIABLE=clog_retry VALUE=False
        UPDATE_DELAYED_GCODE ID=CHECK_NOZZLE_CLOG DURATION=0
    {% else %}
        {% if printer["print_stats"].state == "printing" and printer["filament_switch_sensor filament_sensor"].filament_detected and printer["gcode_macro variables"].is_manual_feeding != True %}
            UPDATE_DELAYED_GCODE ID=CHECK_NOZZLE_CLOG DURATION=1
        {% else %}
            UPDATE_DELAYED_GCODE ID=CHECK_NOZZLE_CLOG DURATION=0
        {% endif %}
        SET_GCODE_VARIABLE MACRO=variables VARIABLE=plug_status VALUE=False
        SET_GCODE_VARIABLE MACRO=variables VARIABLE=clog_retry VALUE=False
    {% endif %}
    
[gcode_macro CHECK_FILAMENT_STATUS]
gcode:
    {% if printer["filament_switch_sensor filament_sensor"].filament_detected %}
        SET_PIN PIN=green_led VALUE=1  
        SET_PIN PIN=red_led VALUE=0
        SET_PIN PIN=blue_led VALUE=0
    {% else %}
        SET_PIN PIN=green_led VALUE=0 
        SET_PIN PIN=red_led VALUE=0
        SET_PIN PIN=blue_led VALUE=0
    {% endif %}

[delayed_gcode INITIAL_FILAMENT_CHECK]
gcode:
    CHECK_FILAMENT_STATUS  
initial_duration: 1  

[gcode_macro BUFFER_LONG_UNLOAD_FILAMENT]
gcode:
    UNLOAD_FILAMENT
    M400
    BUFFER_STEPPER STEPPER=filament_buffer MOVE=-100 SPEED=10
    BUFFER_STEPPER STEPPER=filament_buffer MOVE=-2000 SPEED=50
    G4 P50000

[gcode_macro MANUAL_FEED]
gcode:
    {% if printer["filament_switch_sensor filament_sensor"].filament_detected and printer["buffer_stepper filament_buffer"].push_triggered %}
        BUFFER_STEPPER STEPPER=filament_buffer MOVE=25 SPEED=100 SYNC=1
    {% endif %}
